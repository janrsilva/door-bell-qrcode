"use client";

import { useState, useEffect, useRef } from "react";
import { useSession, signOut } from "next-auth/react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import ApiService from "@/lib/api";
import { useAutoSubscription } from "@/hooks/useAutoSubscription";

interface CallPageContentProps {
  user: {
    id: number;
    name: string;
    email: string;
    cpf: string;
    phone: string;
    addressId: number;
    address: {
      id: number;
      addressUuid: string;
      street: string;
      number: string;
      neighborhood: string;
      city: string;
      state: string;
      zipCode: string;
    };
  };
}

export function CallPageContent({ user }: CallPageContentProps) {
  const { data: session } = useSession();
  const [isOnline, setIsOnline] = useState(true);
  const [isInstallable, setIsInstallable] = useState(false);
  const deferredPromptRef = useRef<any>(null);

  // Hook para configura√ß√£o autom√°tica de subscriptions
  const {
    isConfiguring: isAutoConfiguring,
    isConfigured: notificationsConfigured,
    error: subscriptionError,
  } = useAutoSubscription();

  // Status PWA
  const [isPWA, setIsPWA] = useState(false);
  const [isInstalled, setIsInstalled] = useState(false);

  useEffect(() => {
    // Verificar se est√° rodando como PWA
    const checkPWA = () => {
      const isStandalone = window.matchMedia(
        "(display-mode: standalone)"
      ).matches;
      const isIOSPWA = (window.navigator as any).standalone === true;
      setIsPWA(isStandalone || isIOSPWA);
      setIsInstalled(isStandalone || isIOSPWA);
    };

    checkPWA();

    // Subscription √© gerenciada pelo hook useAutoSubscription

    // Event listener para installabilidade
    const handleBeforeInstallPrompt = (e: Event) => {
      e.preventDefault();
      deferredPromptRef.current = e;
      setIsInstallable(true);
    };

    window.addEventListener("beforeinstallprompt", handleBeforeInstallPrompt);

    // Status online/offline
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener("online", handleOnline);
    window.addEventListener("offline", handleOffline);

    return () => {
      window.removeEventListener(
        "beforeinstallprompt",
        handleBeforeInstallPrompt
      );
      window.removeEventListener("online", handleOnline);
      window.removeEventListener("offline", handleOffline);
    };
  }, []);

  const installApp = async () => {
    if (deferredPromptRef.current) {
      deferredPromptRef.current.prompt();
      const { outcome } = await deferredPromptRef.current.userChoice;

      if (outcome === "accepted") {
        setIsInstallable(false);
        setIsInstalled(true);
      }

      deferredPromptRef.current = null;
    }
  };

  const handleLogout = async () => {
    try {
      await signOut({ callbackUrl: "/auth/login" });
    } catch (error) {
      console.error("Erro no logout:", error);
    }
  };

  const playRingSound = async () => {
    try {
      console.log("üîî Testando som da campainha...");
      const audio = new Audio("/sounds/doorbell.mp3");
      audio.volume = 1.0;
      await audio.play();

      // Simular padr√£o de campainha (3 toques)
      for (let i = 0; i < 2; i++) {
        setTimeout(
          async () => {
            try {
              const repeatAudio = new Audio("/sounds/doorbell.mp3");
              repeatAudio.volume = 1.0;
              await repeatAudio.play();
              console.log(`üîî Toque da campainha ${i + 2}/3`);
            } catch (e) {
              console.log(`Erro no toque ${i + 2}:`, e);
            }
          },
          (i + 1) * 2000
        );
      }

      console.log("üéµ Som da campainha reproduzido com sucesso");
    } catch (error) {
      console.error("‚ùå Erro ao reproduzir som da campainha:", error);
    }
  };

  const testRealPush = async () => {
    try {
      const response = await fetch("/api/debug/test-real-push", {
        method: "POST",
      });

      if (response.ok) {
        console.log("‚úÖ Push test enviado!");
      } else {
        console.error("‚ùå Erro no push test:", await response.text());
      }
    } catch (error) {
      console.error("‚ùå Erro ao testar push:", error);
    }
  };

  const testUserProfile = async () => {
    try {
      console.log("üîç Testando API de perfil...");
      const result = await ApiService.getUserProfile();
      if (result.ok) {
        alert(`‚úÖ API Perfil: ${JSON.stringify(result.data, null, 2)}`);
      } else {
        alert(`‚ùå Erro API Perfil: ${result.error}`);
      }
    } catch (error: any) {
      console.error("‚ùå Erro API Perfil:", error);
      alert(`‚ùå Erro API Perfil: ${error.message}`);
    }
  };

  const testAdminStats = async () => {
    try {
      console.log("üìä Testando API de stats...");
      const result = await ApiService.getAdminStats();
      if (result.ok) {
        alert(`‚úÖ API Stats: ${JSON.stringify(result.data, null, 2)}`);
      } else {
        alert(`‚ùå Erro API Stats: ${result.error}`);
      }
    } catch (error: any) {
      console.error("‚ùå Erro API Stats:", error);
      alert(`‚ùå Erro API Stats: ${error.message}`);
    }
  };

  const testDebugMiddleware = async () => {
    try {
      console.log("üõ°Ô∏è Testando middleware...");
      const result = await ApiService.debugMiddleware();
      if (result.ok) {
        alert(`‚úÖ Middleware: ${JSON.stringify(result.data, null, 2)}`);
      } else {
        alert(`‚ùå Erro Middleware: ${result.error}`);
      }
    } catch (error: any) {
      console.error("‚ùå Erro Middleware:", error);
      alert(`‚ùå Erro Middleware: ${error.message}`);
    }
  };

  const debugSubscriptions = async () => {
    try {
      console.log("üîç Debugando subscriptions...");
      const result = await ApiService.debugSubscriptions();
      if (result.ok) {
        const data = result.data;
        console.log("üìä Debug subscriptions:", data);

        let report = `üîç DEBUG SUBSCRIPTIONS:\n\n`;
        report += `üìä Total: ${data.total}\n\n`;

        if (data.total === 0) {
          report += `‚ùå NENHUMA SUBSCRIPTION ENCONTRADA!\n`;
          report += `üîß Configure notifica√ß√µes no PWA primeiro.`;
        } else {
          report += `üìã Por Endere√ßo:\n`;
          for (const [addressId, subs] of Object.entries(data.byAddress)) {
            report += `  üè† AddressId ${addressId}: ${(subs as any[]).length} dispositivos\n`;
          }

          report += `\nüéØ Usu√°rio atual: AddressId = ${user.addressId}\n`;

          if (data.byAddress[user.addressId.toString()]) {
            report += `‚úÖ Encontrado ${data.byAddress[user.addressId.toString()].length} dispositivos para seu endere√ßo`;
          } else {
            report += `‚ùå NENHUM dispositivo para seu endere√ßo!`;
          }
        }

        alert(report);
      } else {
        alert(`‚ùå Erro ao buscar subscriptions: ${result.error}`);
      }
    } catch (error: any) {
      console.error("‚ùå Erro no debug:", error);
      alert(`‚ùå Erro: ${error.message}`);
    }
  };

  const forceUpdatePWA = async () => {
    try {
      console.log("üîÑ For√ßando atualiza√ß√£o do PWA...");

      if (!("serviceWorker" in navigator)) {
        alert("‚ùå Service Worker n√£o suportado neste navegador");
        return;
      }

      // Remover todos os service workers
      const registrations = await navigator.serviceWorker.getRegistrations();
      console.log(`üóëÔ∏è Removendo ${registrations.length} service workers...`);

      for (const registration of registrations) {
        await registration.unregister();
        console.log("‚úÖ Service Worker removido");
      }

      // Limpar cache
      if ("caches" in window) {
        const cacheNames = await caches.keys();
        console.log(`üóëÔ∏è Limpando ${cacheNames.length} caches...`);

        for (const cacheName of cacheNames) {
          await caches.delete(cacheName);
          console.log(`‚úÖ Cache removido: ${cacheName}`);
        }
      }

      // Limpar localStorage e sessionStorage relacionado ao PWA
      localStorage.removeItem("notificationsConfigured");
      sessionStorage.clear(); // Limpar controle de execu√ß√£o do hook
      console.log("üóëÔ∏è localStorage e sessionStorage limpos");

      alert(
        "‚úÖ PWA atualizado! A p√°gina ser√° recarregada em 2 segundos para aplicar as mudan√ßas."
      );

      // Recarregar p√°gina para reinstalar SW
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } catch (error: any) {
      console.error("‚ùå Erro ao for√ßar atualiza√ß√£o:", error);
      alert(`‚ùå Erro ao atualizar PWA: ${error.message}`);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="mx-auto max-w-4xl">
        {/* Header */}
        <div className="mb-6 text-center">
          <h1 className="text-3xl font-bold text-gray-900">
            üîî Painel de Atendimento
          </h1>
          <p className="mt-2 text-gray-600">
            Bem-vindo, {user.name}! Seu sistema est√°{" "}
            {isOnline ? "üü¢ online" : "üî¥ offline"}
          </p>
        </div>

        {/* User Info Card */}
        <Card className="mb-6 p-6">
          <h2 className="mb-4 text-xl font-semibold">
            üë§ Informa√ß√µes do Usu√°rio
          </h2>
          <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <p>
                <strong>Nome:</strong> {user.name}
              </p>
              <p>
                <strong>CPF:</strong> {user.cpf}
              </p>
              <p>
                <strong>Email:</strong> {user.email}
              </p>
              <p>
                <strong>Telefone:</strong> {user.phone}
              </p>
            </div>
            <div>
              <p>
                <strong>Endere√ßo:</strong>
              </p>
              <p>
                {user.address.street}, {user.address.number}
              </p>
              <p>{user.address.neighborhood}</p>
              <p>
                {user.address.city}, {user.address.state}
              </p>
              <p>CEP: {user.address.zipCode}</p>
            </div>
          </div>
          <div className="mt-4 flex justify-end">
            <Button
              onClick={handleLogout}
              variant="outline"
              className="text-red-600 hover:bg-red-50"
            >
              üö™ Sair
            </Button>
          </div>
        </Card>

        {/* PWA Status Card */}
        <Card className="mb-6 p-6">
          <h2 className="mb-4 text-xl font-semibold">üì± Status do PWA</h2>
          <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <p>
                üîß <strong>PWA Instalado:</strong>{" "}
                {isInstalled ? "‚úÖ Sim" : "‚ùå N√£o"}
              </p>
              <p>
                üîî <strong>Notifica√ß√µes:</strong>{" "}
                {notificationsConfigured
                  ? "‚úÖ Permitidas"
                  : subscriptionError
                    ? "‚ùå Negadas"
                    : "‚ö†Ô∏è Configurando..."}
              </p>
              <p>
                üì° <strong>Push Configurado:</strong>{" "}
                {isAutoConfiguring
                  ? "üîÑ Configurando automaticamente..."
                  : notificationsConfigured
                    ? "‚úÖ Sim"
                    : "‚ùå N√£o"}
              </p>
              {isAutoConfiguring && (
                <p className="text-sm text-blue-600">
                  üîç Verificando subscriptions ap√≥s login...
                </p>
              )}
            </div>
            <div className="space-y-2">
              {isInstallable && (
                <Button onClick={installApp} className="w-full">
                  üì≤ Instalar PWA
                </Button>
              )}

              {!notificationsConfigured && isAutoConfiguring && (
                <div className="w-full text-center py-2 px-4 bg-blue-50 border border-blue-200 rounded-md">
                  <p className="text-blue-700 font-medium">
                    üîÑ Configurando automaticamente...
                  </p>
                  <p className="text-xs text-blue-600 mt-1">
                    Aceite a permiss√£o se solicitada pelo navegador
                  </p>
                </div>
              )}

              {!notificationsConfigured && !isAutoConfiguring && (
                <div className="w-full text-center py-2 px-4 bg-red-50 border border-red-200 rounded-md">
                  <p className="text-red-700 font-medium">
                    ‚ùå Configura√ß√£o autom√°tica falhou
                  </p>
                  {subscriptionError && (
                    <p className="text-xs text-red-600 mt-1">
                      Erro: {subscriptionError}
                    </p>
                  )}
                  <p className="text-xs text-red-600 mt-1">
                    Verifique as configura√ß√µes de notifica√ß√£o do navegador
                  </p>
                </div>
              )}

              {notificationsConfigured && (
                <div className="text-center text-green-600 font-medium">
                  ‚úÖ Sistema totalmente configurado!
                </div>
              )}

              {/* Bot√£o de Atualiza√ß√£o PWA */}
              <div className="mt-4 pt-4 border-t border-gray-200">
                <Button
                  onClick={forceUpdatePWA}
                  variant="outline"
                  size="sm"
                  className="w-full bg-blue-50 hover:bg-blue-100 border-blue-300 text-blue-700"
                >
                  üîÑ For√ßar Atualiza√ß√£o do PWA
                </Button>
                <p className="text-xs text-blue-600 mt-2 text-center">
                  Use se o som da campainha n√£o estiver funcionando
                </p>
              </div>
            </div>
          </div>
        </Card>

        {/* Test Buttons */}
        <Card className="mb-6 p-6">
          <h2 className="mb-4 text-xl font-semibold">üß™ Testes do Sistema</h2>
          <div className="grid grid-cols-2 gap-3 md:grid-cols-4">
            <Button onClick={playRingSound} variant="outline">
              üîî Som da Campainha
            </Button>

            <Button onClick={testRealPush} variant="outline">
              üß™ Teste Real Push
            </Button>

            <Button
              onClick={() => window.open("/teste-campainha", "_blank")}
              variant="outline"
            >
              üö™ P√°gina Visitante
            </Button>

            <Button onClick={testUserProfile} variant="outline">
              üë§ API Perfil
            </Button>

            <Button onClick={testAdminStats} variant="outline">
              üìä API Stats
            </Button>

            <Button onClick={testDebugMiddleware} variant="outline">
              üõ°Ô∏è Debug Middleware
            </Button>

            <Button onClick={debugSubscriptions} variant="outline">
              üîç Debug Subscriptions
            </Button>

            <Button
              onClick={() => window.open("/api/debug/ring-direct", "_blank")}
              variant="outline"
            >
              üîî Ring Direto
            </Button>
          </div>
        </Card>

        {/* Instructions */}
        <Card className="p-6">
          <h2 className="mb-4 text-xl font-semibold">üìã Instru√ß√µes</h2>
          <div className="space-y-3 text-gray-700">
            <p>
              1. <strong>Instale o PWA</strong> para receber notifica√ß√µes mesmo
              com o app fechado
            </p>
            <p>
              2. <strong>Configure as notifica√ß√µes</strong> para ser alertado
              quando algu√©m tocar a campainha
            </p>
            <p>
              3. <strong>Compartilhe o QR Code</strong> do seu endere√ßo para que
              visitantes possam tocar sua campainha
            </p>
            <p>
              4. <strong>Mantenha o volume alto</strong> para ouvir os alertas
              de campainha
            </p>
          </div>
        </Card>
      </div>
    </div>
  );
}
